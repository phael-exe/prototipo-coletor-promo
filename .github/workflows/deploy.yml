# .github/workflows/deploy.yml
name: Deploy to Cloud Run

on:
  release:
    types: [published, released]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  GCP_REGION: us-central1
  IMAGE_NAME: coletor-promo
  GAR_REPOSITORY: docker-repo

permissions:
  contents: read
  id-token: write

jobs:
  build-and-deploy:
    name: Build & Deploy to Cloud Run
    runs-on: ubuntu-latest
    
    env:
      IMAGE_TAG: ${{ github.ref_name }}

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ”‘ Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: â˜ï¸ Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          export_default_credentials: true

      - name: ðŸ” Configure Docker authentication to Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: ðŸ·ï¸ Set image tags
        id: image
        run: |
          IMAGE_TAG=${{ github.ref_name }}
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            IMAGE_TAG=${{ github.event.inputs.environment }}-${{ github.sha | cut -c1-7 }}
          fi
          
          FULL_IMAGE_PATH=${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}
          
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "full_path=${FULL_IMAGE_PATH}" >> $GITHUB_OUTPUT
          echo "image_uri=${FULL_IMAGE_PATH}:${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "image_uri_latest=${FULL_IMAGE_PATH}:latest" >> $GITHUB_OUTPUT

      - name: ðŸ³ Build Docker image
        run: |
          docker build \
            --tag "${{ steps.image.outputs.image_uri }}" \
            --tag "${{ steps.image.outputs.image_uri_latest }}" \
            --label "version=${{ steps.image.outputs.image_tag }}" \
            --label "commit=${{ github.sha }}" \
            --label "date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
            .

      - name: ðŸš€ Push Docker image to Artifact Registry
        run: |
          docker push "${{ steps.image.outputs.image_uri }}"
          docker push "${{ steps.image.outputs.image_uri_latest }}"
          
          echo "âœ… Image pushed to Artifact Registry"
          echo "ðŸ“ URI: ${{ steps.image.outputs.image_uri }}"

      - name: ðŸŒ Deploy to Cloud Run (Staging)
        if: github.event_name == 'release' || github.event.inputs.environment == 'staging'
        run: |
          gcloud run deploy coletor-promo \
            --image "${{ steps.image.outputs.image_uri }}" \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --set-env-vars "ENVIRONMENT=staging,GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }},GCP_DATASET_ID=${{ secrets.GCP_DATASET_ID }},LOG_LEVEL=INFO,ENABLE_CLOUD_LOGGING=true" \
            --memory 512Mi \
            --cpu 1 \
            --timeout 3600 \
            --max-instances 10 \
            --labels "version=${{ steps.image.outputs.image_tag }},commit=${{ github.sha }},environment=staging"

      - name: ðŸŒ Deploy to Cloud Run (Production)
        if: github.event.inputs.environment == 'production'
        run: |
          gcloud run deploy coletor-promo \
            --image "${{ steps.image.outputs.image_uri }}" \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --set-env-vars "ENVIRONMENT=production,GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }},GCP_DATASET_ID=${{ secrets.GCP_DATASET_ID }},LOG_LEVEL=INFO,ENABLE_CLOUD_LOGGING=true" \
            --memory 1Gi \
            --cpu 2 \
            --timeout 3600 \
            --max-instances 50 \
            --labels "version=${{ steps.image.outputs.image_tag }},commit=${{ github.sha }},environment=production"

      - name: ðŸ“Š Get Cloud Run service details
        id: service
        run: |
          URL=$(gcloud run services describe coletor-promo \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --format='value(status.url)')
          
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "service_name=coletor-promo" >> $GITHUB_OUTPUT

      - name: âœ… Deployment verification
        run: |
          # Wait for service to be ready
          echo "â³ Waiting for service to be ready..."
          sleep 10
          
          # Test health endpoint
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.service.outputs.url }}/health")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "âœ… Health check passed (HTTP $RESPONSE)"
          else
            echo "âš ï¸ Health check returned HTTP $RESPONSE"
          fi

      - name: ðŸ” Cloud Logging Configuration
        run: |
          echo "ðŸ“Š Setting up Cloud Logging..."
          
          # Enable detailed logging in Cloud Run
          gcloud run services update coletor-promo \
            --region ${{ env.GCP_REGION }} \
            --set-env-vars LOG_LEVEL=INFO,ENABLE_CLOUD_LOGGING=true \
            2>/dev/null || true
          
          echo "âœ… Cloud Logging configured"
          echo "ðŸ“ View logs at: https://console.cloud.google.com/logs/query?project=${{ secrets.GCP_PROJECT_ID }}"

      - name: ðŸ“‹ Deployment Summary
        if: always()
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Image Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Image URI**: \`${{ steps.image.outputs.image_uri }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: \`${{ steps.image.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Cloud Run" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: \`${{ steps.service.outputs.service_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: \`${{ env.GCP_REGION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: [${{ steps.service.outputs.url }}](${{ steps.service.outputs.url }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Logs" >> $GITHUB_STEP_SUMMARY
          echo "- [View in Cloud Logging](https://console.cloud.google.com/logs/query?project=${{ secrets.GCP_PROJECT_ID }}&query=resource.type%3D%22cloud_run_revision%22%20AND%20resource.labels.service_name%3D%22${{ steps.service.outputs.service_name }}%22)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Monitoring" >> $GITHUB_STEP_SUMMARY
          echo "- [Cloud Run Dashboard](https://console.cloud.google.com/run?project=${{ secrets.GCP_PROJECT_ID }})" >> $GITHUB_STEP_SUMMARY
          echo "- [BigQuery Tables](https://console.cloud.google.com/bigquery?project=${{ secrets.GCP_PROJECT_ID }}&d=${{ secrets.GCP_DATASET_ID }})" >> $GITHUB_STEP_SUMMARY
